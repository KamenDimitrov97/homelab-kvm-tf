# Permission denied for `virsh start cp1`

This was the first major roadblock I encountered.

## Description

After `terraform apply` has successfully created all the vms, downloads the ubuntu img etc. 
`virsh start cp1` returned a Permission Denied issue:
```sh
error: Failed to start domain 'cp1' error: internal error: 
process exited while connecting to monitor: 2025-12-18T08:46:15.183726Z qemu-system-x86_64:
-blockdev {
    "driver":"file",
    "filename":"/var/lib/libvirt/images/ubuntu-24.04-base.qcow2",
    "node-name":"libvirt-4-storage",
    "auto-read-only":true,
    "discard":"unmap"
}: Could not open '/var/lib/libvirt/images/ubuntu-24.04-base.qcow2': Permission denied
``` 
I have tried  many things. Most of which revolving around testing the permission of the libvirt user and kvm groups permissions. Which did not work.

## What's causing this error?

Well, `libvirt` auto-generates per-VM `AppArmor` profiles from the domain XML, which is generated by `libvirt_domain` tf resource. 

My vm disks are layered qcow2 imgs. That is because they have a backing file which is `ubuntu-24.04-base.qcow2`. My idea was that there is no point in downloading image per vm and I would use the backing feature of kvm stack.

This makes the base image `ubuntu-24.04-base.qcow2` not declared as a disk in the XML but only a backing file on the disk.

AppArmor profiles are path-explicit. If a path is not known when the profile is generated, it is not allowed.

Result: the profile allowed cp1-root.qcow2 but did not allow the backing file, so QEMU was denied when it tried to open it. This has nothing to do with the permission of libvirt or the kvm stack group.

## How to debug?

There are no obvious denied logs if you try AppArmor systemclt logs. 
This is because the deny is happening in the qemu process profile, not libvertd.

I personally just disabled AppArmor for testing purposes. Lo and behold `virsh start cp1` worked!

## How to fix permanently?

Well, I was almost ready to admit defeat so one option was:

1. Completely remove the backing files feature from the vm domain creation in `vms.tf`.
Make sure every vm pulls its own image and installs that.

Then I moved to anger:
2. Completely remove AppArmor? Well what is AppArmor anyway, I do not know what it is or what it does, so fuck it.

Acceptance:
3. No, I decided to prolong my suffering and try to figure out how to make this work.

